local _G = {
   ControllerID = 9822837105,
   CommandCooldown = {}
}

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local function isOwner(player)
    return player.UserId == _G.ControllerID
end

local function notifyPlayer(player, message)
    pcall(function()
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "Control System",
            Text = message,
            Icon = "rbxassetid://0",
            Duration = 5
        })
    end)
end

local function findPlayerByName(name)
    local nameLower = name:lower()
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Name:lower():find(nameLower) or 
           player.DisplayName:lower():find(nameLower) then
            return player
        end
    end
    return nil
end

local function checkCooldown(player)
    if _G.CommandCooldown[player.UserId] and os.time() - _G.CommandCooldown[player.UserId] < 2 then
        notifyPlayer(player, "⏳ Wait 2 seconds between commands")
        return false
    end
    _G.CommandCooldown[player.UserId] = os.time()
    return true
end

local function killPlayer(targetPlayer, killerName)
    if not targetPlayer or not targetPlayer.Character then
        return false
    end
    
    local humanoid = targetPlayer.Character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid.Health = 0
        print("💀 Killed "..targetPlayer.Name.." by "..killerName)
        return true
    end
    return false
end

local function killAllPlayers(killerName)
    local players = Players:GetPlayers()
    local killedCount = 0
    
    for _, player in ipairs(players) do
        if player.Character and not isOwner(player) then
            if killPlayer(player, killerName) then
                killedCount = killedCount + 1
            end
        end
    end
    
    print("💀 Killed "..killedCount.." players by "..killerName)
    return killedCount
end

local function bringPlayer(targetPlayer, bringerName)
    if not targetPlayer or not targetPlayer.Character then
        return false
    end
    
    local bringer = Players:FindFirstChild(bringerName)
    if not bringer or not bringer.Character then
        return false
    end
    
    local targetRoot = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
    local bringerRoot = bringer.Character:FindFirstChild("HumanoidRootPart")
    
    if targetRoot and bringerRoot then
        targetRoot.Velocity = Vector3.new(0, 0, 0)
        targetRoot.RotVelocity = Vector3.new(0, 0, 0)
        
        local offset = bringerRoot.CFrame.LookVector * 5
        targetRoot.CFrame = bringerRoot.CFrame + offset + Vector3.new(0, 3, 0)
        
        print("🎯 Brought "..targetPlayer.Name.." to "..bringerName)
        return true
    end
    return false
end

local function bringAllPlayers(bringerName)
    local bringer = Players:FindFirstChild(bringerName)
    if not bringer or not bringer.Character then return 0 end
    
    local players = Players:GetPlayers()
    local broughtCount = 0
    
    for i, player in ipairs(players) do
        if player ~= bringer and player.Character then
            if bringPlayer(player, bringerName) then
                broughtCount = broughtCount + 1
                wait(0.3)
            end
        end
    end
    
    print("🎯 Brought "..broughtCount.." players to "..bringerName)
    return broughtCount
end

local function kickPlayer(targetPlayer, kickerName)
    if not targetPlayer then return false end
    
    pcall(function()
        targetPlayer:Kick("🚫 Kicked by "..kickerName)
        print("🚫 Kicked "..targetPlayer.Name.." by "..kickerName)
    end)
    
    return true
end

local function kickAllPlayers(kickerName)
    local players = Players:GetPlayers()
    local kickedCount = 0
    
    for _, player in ipairs(players) do
        if not isOwner(player) then
            if kickPlayer(player, kickerName) then
                kickedCount = kickedCount + 1
            end
        end
    end
    
    print("🚫 Kicked "..kickedCount.." players by "..kickerName)
    return kickedCount
end

local flingConnections = {}
local function flingPlayer(targetPlayer, flingerName)
    if not targetPlayer or not targetPlayer.Character then
        return false
    end
    
    local targetRoot = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not targetRoot then return false end
    
    if flingConnections[targetPlayer.UserId] then
        flingConnections[targetPlayer.UserId]:Disconnect()
        flingConnections[targetPlayer.UserId] = nil
    end
    
    local flingForce = Instance.new("BodyVelocity")
    flingForce.Velocity = Vector3.new(
        math.random(-500, 500),
        math.random(200, 500),
        math.random(-500, 500)
    )
    flingForce.MaxForce = Vector3.new(10000, 10000, 10000)
    flingForce.Parent = targetRoot
    
    delay(3, function()
        if flingForce and flingForce.Parent then
            flingForce:Destroy()
        end
        if flingConnections[targetPlayer.UserId] then
            flingConnections[targetPlayer.UserId]:Disconnect()
            flingConnections[targetPlayer.UserId] = nil
        end
    end)
    
    print("🌀 Flinged "..targetPlayer.Name.." by "..flingerName)
    return true
end

local function flingAllPlayers(flingerName)
    local players = Players:GetPlayers()
    local flungCount = 0
    
    for _, player in ipairs(players) do
        if not isOwner(player) then
            if flingPlayer(player, flingerName) then
                flungCount = flungCount + 1
            end
        end
    end
    
    print("🌀 Flinged "..flungCount.." players by "..flingerName)
    return flungCount
end

local function processCommand(player, message)
    local command = message:lower()
    
    if not checkCooldown(player) then return end
    
    if isOwner(player) then
        if command == "!kill all" then
            local count = killAllPlayers(player.Name)
            notifyPlayer(player, "💀 Killed "..count.." players")
            
        elseif command:sub(1, 6) == "!kill " then
            local targetName = command:sub(7)
            if targetName and targetName ~= "" then
                local targetPlayer = findPlayerByName(targetName)
                if targetPlayer then
                    if killPlayer(targetPlayer, player.Name) then
                        notifyPlayer(player, "💀 Killed "..targetPlayer.Name)
                    else
                        notifyPlayer(player, "❌ Failed to kill "..targetPlayer.Name)
                    end
                else
                    notifyPlayer(player, "❌ Player not found: "..targetName)
                end
            end
            
        elseif command == "!bring all" then
            local count = bringAllPlayers(player.Name)
            notifyPlayer(player, "🎯 Brought "..count.." players")
            
        elseif command:sub(1, 7) == "!bring " then
            local targetName = command:sub(8)
            if targetName and targetName ~= "" then
                local targetPlayer = findPlayerByName(targetName)
                if targetPlayer then
                    if bringPlayer(targetPlayer, player.Name) then
                        notifyPlayer(player, "🎯 Brought "..targetPlayer.Name)
                    else
                        notifyPlayer(player, "❌ Failed to bring "..targetPlayer.Name)
                    end
                else
                    notifyPlayer(player, "❌ Player not found: "..targetName)
                end
            end
            
        elseif command == "!kick all" then
            local count = kickAllPlayers(player.Name)
            notifyPlayer(player, "🚫 Kicked "..count.." players")
            
        elseif command:sub(1, 6) == "!kick " then
            local targetName = command:sub(7)
            if targetName and targetName ~= "" then
                local targetPlayer = findPlayerByName(targetName)
                if targetPlayer then
                    if kickPlayer(targetPlayer, player.Name) then
                        notifyPlayer(player, "🚫 Kicked "..targetPlayer.Name)
                    end
                else
                    notifyPlayer(player, "❌ Player not found: "..targetName)
                end
            end
            
        elseif command == "!fling all" then
            local count = flingAllPlayers(player.Name)
            notifyPlayer(player, "🌀 Flinged "..count.." players")
            
        elseif command:sub(1, 7) == "!fling " then
            local targetName = command:sub(8)
            if targetName and targetName ~= "" then
                local targetPlayer = findPlayerByName(targetName)
                if targetPlayer then
                    if flingPlayer(targetPlayer, player.Name) then
                        notifyPlayer(player, "🌀 Flinged "..targetPlayer.Name)
                    else
                        notifyPlayer(player, "❌ Failed to fling "..targetPlayer.Name)
                    end
                else
                    notifyPlayer(player, "❌ Player not found: "..targetName)
                end
            end
            
        elseif command == "!help" then
            notifyPlayer(player, "🎮 Commands: !kill, !bring, !kick, !fling + [all/name]")
        end
        
    else
        if command:sub(1, 6) == "!kill " then
            local targetName = command:sub(7)
            local targetPlayer = findPlayerByName(targetName)
            if targetPlayer and targetPlayer ~= player then
                if killPlayer(targetPlayer, player.Name) then
                    notifyPlayer(player, "💀 Killed "..targetPlayer.Name)
                end
            end
            
        elseif command:sub(1, 7) == "!bring " then
            local targetName = command:sub(8)
            local targetPlayer = findPlayerByName(targetName)
            if targetPlayer and targetPlayer ~= player then
                if bringPlayer(targetPlayer, player.Name) then
                    notifyPlayer(player, "🎯 Brought "..targetPlayer.Name)
                end
            end
            
        elseif command:sub(1, 7) == "!fling " then
            local targetName = command:sub(8)
            local targetPlayer = findPlayerByName(targetName)
            if targetPlayer and targetPlayer ~= player then
                if flingPlayer(targetPlayer, player.Name) then
                    notifyPlayer(player, "🌀 Flinged "..targetPlayer.Name)
                end
            end
            
        elseif command:sub(1, 6) == "!kick " or command == "!kick all" then
            notifyPlayer(player, "❌ You are not allowed to use kick command")
            
        elseif command:endswith(" all") then
            notifyPlayer(player, "❌ You are not allowed to use commands on everyone")
        end
    end
end

local function monitorPlayer(player)
    player.Chatted:Connect(function(message)
        if message:lower():sub(1, 1) == "!" then
            processCommand(player, message)
        end
    end)
end

local function startMonitoring()
    for _, player in ipairs(Players:GetPlayers()) do
        monitorPlayer(player)
    end
end

Players.PlayerAdded:Connect(function(player)
    monitorPlayer(player)
    if isOwner(player) then
        print("⭐ Owner joined the game! (9822837105)")
        notifyPlayer(player, "🎮 You are the owner! Use !help for commands")
    end
end)

print("🎮 Control system activated!")
print("🎮 Owner ID: 9822837105")
startMonitoring()

local localPlayer = Players.LocalPlayer
if localPlayer and isOwner(localPlayer) then
    notifyPlayer(localPlayer, "🎮 Control system ready! Use !help")
end

return {
    kill = killPlayer,
    bring = bringPlayer,
    kick = kickPlayer,
    fling = flingPlayer,
    
    killAll = killAllPlayers,
    bringAll = bringAllPlayers,
    kickAll = kickAllPlayers,
    flingAll = flingAllPlayers,
    
    isOwner = isOwner,
    getInfo = function()
        return {
            OwnerID = _G.ControllerID,
            TotalPlayers = #Players:GetPlayers(),
            IsOwner = isOwner(Players.LocalPlayer)
        }
    end
}
